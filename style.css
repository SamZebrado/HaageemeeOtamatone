:root{
  --bg: #0b0d12;
  --card: rgba(255,255,255,0.06);
  --card2: rgba(255,255,255,0.09);
  --text: rgba(255,255,255,0.92);
  --muted: rgba(255,255,255,0.70);
  --muted2: rgba(255,255,255,0.55);
  --accent: #ffb057;
  --accent2:#ffd6a4;
  --line: rgba(255,255,255,0.14);
  --shadow: 0 16px 40px rgba(0,0,0,0.45);
}

*{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
html, body{ height:100%; margin:0; background: radial-gradient(1200px 700px at 30% 10%, rgba(255,176,87,0.08), transparent 60%),
                                     radial-gradient(900px 500px at 80% 30%, rgba(140,170,255,0.08), transparent 55%),
                                     var(--bg);
            color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", Arial, sans-serif;
}

.app{ min-height:100%; padding: 14px 14px 18px; display:flex; flex-direction:column; gap:12px; max-width:1100px; margin:0 auto; }

.topbar{
  display:flex; align-items:center; justify-content:space-between;
  background: var(--card);
  border:1px solid var(--line);
  border-radius: 16px;
  padding: 10px 12px;
  box-shadow: var(--shadow);
}

.brand{ display:flex; align-items:center; gap:10px; }
.brand .dot{
  width:12px; height:12px; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
  box-shadow: 0 0 0 6px rgba(255,176,87,0.12);
}
.title .t1{ font-weight:700; letter-spacing: 0.2px; }
.title .t2{ font-size: 12px; color: var(--muted2); margin-top:2px; }

.btn{
  appearance:none; border:none; cursor:pointer;
  padding: 10px 12px;
  border-radius: 14px;
  background: var(--card2);
  color: var(--text);
  border:1px solid var(--line);
  box-shadow: 0 10px 24px rgba(0,0,0,0.25);
  font-weight: 600;
  touch-action: none;
}
.btn:active{ transform: translateY(1px); }
.btn.primary{
  background: linear-gradient(180deg, rgba(255,176,87,0.22), rgba(255,176,87,0.12));
  border-color: rgba(255,176,87,0.35);
}

.stage{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
  background: var(--card);
  border:1px solid var(--line);
  border-radius: 18px;
  padding: 12px;
  box-shadow: var(--shadow);
}

.leftPane{
  display:flex;
  flex-direction:column;
  gap: 12px;
  position: relative;
}

.rightPane{
  display:flex;
  flex-direction:column;
  gap: 12px;
  touch-action: manipulation;
}

.instrument{
  display:flex;
  flex-direction: column;
  align-items:center;
  justify-content:center;
  gap: 10px;
  padding: 6px 4px 8px;
  user-select:none;
  touch-action:none; /* allow multi-touch handling in JS */
  position: relative;
  z-index: 3;
}

.stem{
  width: 90px;
  height: min(64vh, 520px);
  display:flex;
  align-items:stretch;
  justify-content:center;
  transform: translate(var(--stem-x, 0px), var(--stem-y, 0px));
  transition: transform 120ms ease;
  touch-action:none;
}

.ribbon{
  position:relative;
  width: 72px;
  height: 100%;
  border-radius: 999px;
  background:
    linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.06)),
    linear-gradient(180deg, rgba(255,176,87,0.22), rgba(255,176,87,0.04));
  border:1px solid rgba(255,255,255,0.18);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.22), 0 18px 40px rgba(0,0,0,0.35);
  overflow:hidden;
}

.ribbon::after{
  content:"";
  position:absolute; inset: 10px 30px 10px 30px;
  border-radius: 999px;
  background: linear-gradient(180deg, rgba(0,0,0,0.38), rgba(0,0,0,0.12));
}

.ribbonHint{
  position:absolute; left:50%; top: 10px;
  transform: translateX(-50%);
  font-size: 12px;
  color: rgba(255,255,255,0.75);
  background: rgba(0,0,0,0.20);
  border:1px solid rgba(255,255,255,0.14);
  padding: 6px 8px;
  border-radius: 999px;
  pointer-events:none;
}

.ribbonCursor{
  position:absolute; left: 10px; right: 10px;
  height: 18px;
  border-radius: 999px;
  background: rgba(255,255,255,0.55);
  border:1px solid rgba(0,0,0,0.35);
  box-shadow: 0 8px 20px rgba(0,0,0,0.35);
  top: 50%;
  transform: translateY(-50%);
  opacity: 0;
  transition: opacity 120ms ease;
}
.ribbon.active .ribbonCursor{ opacity: 1; }
.ribbon.auto .ribbonCursor{ opacity: 1; }

.head{
  position:relative;
  width: min(44vw, 290px);
  aspect-ratio: 1 / 1;
  border-radius: 50%;
  display:flex;
  align-items:center;
  justify-content:center;
  filter: drop-shadow(0 18px 40px rgba(0,0,0,0.42));
  touch-action:none;
}

.catHead{
  position:absolute;
  inset:0;
  border-radius: 50%;
  pointer-events:none;
  --iris: #66c36a;
  --stroke: #3a2617;
  --head-r: 50%;
  --stroke-w: clamp(2px, calc(var(--head-r) * 0.05), 5px);
}
.catHead .ear{
  position:absolute;
  width: 28%;
  height: 28%;
  background: #f6a33c;
  border: var(--stroke-w) solid var(--stroke);
  border-bottom: none;
  clip-path: polygon(50% 2%, 8% 100%, 92% 100%);
  border-radius: 18% 18% 26% 26%;
  transform-origin: 50% 100%;
  transform: translateY(var(--ear-y, 0px)) scaleY(var(--ear-stretch, 1)) rotate(var(--ear-rot, 0deg));
  transition: transform 90ms ease;
  z-index: 1;
}
.catHead .ear.left{ left: 12%; top: -6%; --ear-rot: -6deg; }
.catHead .ear.right{ right: 12%; top: -6%; --ear-rot: 6deg; }
.catHead .ear::before{
  content:"";
  position:absolute;
  inset: calc(var(--stroke-w) * 1.2);
  background: rgba(255,205,190,0.85);
  clip-path: polygon(50% 6%, 12% 100%, 88% 100%);
  border-radius: 18% 18% 26% 26%;
}
.catHead .ear::after{
  content:"";
  position:absolute;
  left: -6%;
  right: -6%;
  bottom: -8%;
  height: 35%;
  background: rgba(140,80,40,0.12);
  border-radius: 999px;
  filter: blur(0.6px);
}
.catHead .face{
  position:absolute;
  inset:0;
  border-radius: 50%;
  background: radial-gradient(circle at 35% 30%, #ffe1b4, #f5a64b 60%, #e58a34 100%);
  border: var(--stroke-w) solid var(--stroke);
  box-shadow: inset 0 -10px 18px rgba(120,60,20,0.18);
  z-index: 2;
  pointer-events:none;
  overflow: visible;
}
.catHead .face::after{
  content:"";
  position:absolute;
  left: 18%;
  top: 14%;
  width: 28%;
  height: 20%;
  background: rgba(255,255,255,0.12);
  border-radius: 999px;
  transform: rotate(-18deg);
}
.catHead .face::before{
  content:"";
  position:absolute;
  inset: 6% 8%;
  border-radius: 50%;
  background:
    radial-gradient(90% 80% at 25% 40%, rgba(175,95,40,0.28), transparent 60%),
    radial-gradient(60% 50% at 70% 30%, rgba(155,80,35,0.26), transparent 62%),
    radial-gradient(70% 60% at 60% 65%, rgba(165,85,35,0.26), transparent 58%),
    radial-gradient(60% 50% at 35% 75%, rgba(150,75,30,0.26), transparent 60%);
  opacity: 0.85;
  mix-blend-mode: normal;
  filter: blur(1.2px);
}
 
.catHead .furNoise{
  position:absolute;
  inset: 0;
  border-radius: 50%;
  background-image:
    radial-gradient(circle, rgba(255,255,255,0.08) 0.6px, transparent 1px),
    radial-gradient(circle, rgba(120,70,30,0.08) 0.6px, transparent 1px);
  background-size: 10px 10px, 12px 12px;
  background-position: 0 0, 5px 5px;
  opacity: 0.35;
  mix-blend-mode: soft-light;
  pointer-events:none;
  z-index: 1;
}
.catHead .tuft{
  position:absolute;
  left: 50%;
  top: -2%;
  width: 16%;
  height: 12%;
  border: var(--stroke-w) solid var(--stroke);
  border-bottom: none;
  border-left: none;
  border-radius: 999px;
  transform: translateX(-50%) rotate(-18deg);
  opacity: 0.8;
}
.catHead .sticker{
  position:absolute;
  left: 10%;
  top: 50%;
  width: 10%;
  height: 10%;
  background: rgba(255,255,255,0.8);
  border: var(--stroke-w) solid var(--stroke);
  border-radius: 20%;
  transform: rotate(-12deg);
  opacity: 0.8;
}
.catHead .eye{
  position:absolute;
  width: 22%;
  aspect-ratio: 1 / 1;
  background: radial-gradient(circle at 35% 30%, #fff7ef, #f1e9e2 70%);
  border-radius: 50%;
  border: var(--stroke-w) solid var(--stroke);
  box-shadow: inset 0 -4px 0 rgba(0,0,0,0.08);
  transform: translateY(var(--eye-y, 0px)) scaleY(var(--eye-s, 1));
  transition: transform 90ms ease;
  z-index: 3;
}
.catHead .eye.left{ left: 22%; top: 32%; }
.catHead .eye.right{ right: 22%; top: 32%; }
.catHead .eye .iris{
  position:absolute;
  inset: 16%;
  background: radial-gradient(circle at 40% 40%, rgba(255,255,255,0.65), var(--iris));
  border-radius: 50%;
  box-shadow: inset 0 0 0 2px rgba(0,0,0,0.14);
  display:flex;
  align-items:center;
  justify-content:center;
}
.catHead .eye .iris::before{
  content:"";
  position:absolute;
  inset: 18%;
  background: radial-gradient(circle at 40% 35%, rgba(255,255,255,0.55), color-mix(in oklab, var(--iris), #ffffff 35%));
  border-radius: 50%;
}
.catHead .eye .pupil{
  position:absolute;
  width: 18%;
  height: 65%;
  background: rgba(25,12,6,0.95);
  border-radius: 999px;
  transform: translateY(var(--pupil-y, 0px)) scaleX(var(--pupil-s, 1));
}
.catHead .eye .iris::after{
  content:"";
  position:absolute;
  width: 20%;
  height: 20%;
  left: 18%;
  top: 16%;
  background: rgba(255,255,255,0.85);
  border-radius: 50%;
}

.catHead .nose{
  position:absolute;
  left: 50%;
  top: 52%;
  width: 10%;
  height: 7%;
  background: #f09a93;
  border: var(--stroke-w) solid var(--stroke);
  border-radius: 999px;
  transform: translateX(-50%);
  box-shadow: inset 0 -2px 0 rgba(0,0,0,0.10);
  z-index: 3;
}
.catHead .philtrum{
  position:absolute;
  left: 50%;
  top: 58%;
  width: 2px;
  height: 7%;
  background: var(--stroke);
  border-radius: 999px;
  transform: translateX(-50%);
  z-index: 3;
}
.catHead .blush{
  position:absolute;
  top: 58%;
  width: 14%;
  height: 8%;
  background: rgba(255,140,120,0.22);
  border-radius: 999px;
  filter: blur(0.6px);
}
.catHead .blush.left{ left: 22%; }
.catHead .blush.right{ right: 22%; }
.catHead .smile{
  position:absolute;
  top: 60%;
  width: 10%;
  height: 10%;
  border-bottom: var(--stroke-w) solid var(--stroke);
  border-radius: 0 0 999px 999px;
  opacity: 0.6;
}
.catHead .smile.left{ left: 36%; transform: rotate(8deg); }
.catHead .smile.right{ right: 36%; transform: rotate(-8deg); }
.catHead .freckles{
  position:absolute;
  top: 54%;
  width: 12%;
  display:flex;
  gap: 4px;
}
.catHead .freckles.left{ left: 18%; }
.catHead .freckles.right{ right: 18%; justify-content:flex-end; }
.catHead .freckles span{
  width: 4px;
  height: 4px;
  background: var(--stroke);
  border-radius: 50%;
  opacity: 0.5;
}
.whiskers{
  position:absolute;
  top: 58%;
  width: 34%;
  display:flex;
  flex-direction:column;
  gap: 6px;
  z-index: 5;
  pointer-events:none;
}
.whiskers.left{ right: -2%; left: auto; align-items:flex-start; }
.whiskers.right{ left: -2%; right: auto; align-items:flex-end; }
.whiskers span{
  display:block;
  height: calc(var(--stroke-w) * 0.8);
  background: #3a2416;
  border-radius: 999px;
  transform-origin: 0 50%;
  transform: rotate(var(--whisker-rot, 0deg));
  opacity: 1;
  filter: none;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.04);
  filter: drop-shadow(0 0 1px rgba(0,0,0,0.25));
}
.whiskers.right span{ transform-origin: 100% 50%; }
.whiskers span:nth-child(1){ width: 100%; margin-bottom: 2px; }
.whiskers span:nth-child(2){ width: 110%; margin-bottom: 8px; }
.whiskers span:nth-child(3){ width: 100%; }

.mouthSvg{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index: 4;
}
.mouthSvg path{
  stroke: none;
  fill: rgba(20,10,6,0.65);
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.22));
}

.headHint{
  position:absolute;
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  color: rgba(255,255,255,0.75);
  background: rgba(0,0,0,0.20);
  border:1px solid rgba(255,255,255,0.14);
  padding: 6px 8px;
  border-radius: 999px;
  pointer-events:none;
}

.app.config-mode .stem{
  transition: none;
  cursor: grab;
  outline: 1px dashed rgba(255,255,255,0.35);
  outline-offset: 8px;
}
.app.config-mode .stem:active{ cursor: grabbing; }
.app.config-mode .ribbon{ pointer-events: none; }
.app.config-mode .ribbonHint{ opacity: 0.35; }

.viz{
  width: 100%;
  height: 160px;
  display:block;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.24);
  position: relative;
  z-index: 3;
}
.vizBg{
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  border-radius: 0;
  border: none;
  background: transparent;
  z-index: 0;
  pointer-events: none;
  opacity: 0.25;
  filter: blur(0.4px) saturate(1.1);
}

.app > *{
  position: relative;
  z-index: 2;
}

.fx{
  position:absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events:none;
  z-index: 2;
  mix-blend-mode: screen;
}

.fxBar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 6px 2px 2px;
  flex-wrap: wrap;
}
.fxLabel{
  font-size: 13px;
  color: var(--muted);
  font-weight: 650;
}
.fxGroup{
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
}
.fxBtn.active{
  border-color: rgba(255,176,87,0.42);
  background: rgba(255,176,87,0.14);
}

.autoBar{
  display:flex;
  flex-direction:column;
  gap: 8px;
  padding: 6px 2px 2px;
}
.autoLabel{
  font-size: 13px;
  color: var(--muted);
  font-weight: 650;
}
.autoGroup{
  display:flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items:center;
}
.select{
  appearance:none;
  background: rgba(0,0,0,0.24);
  color: var(--text);
  border:1px solid rgba(255,255,255,0.16);
  border-radius: 12px;
  padding: 8px 10px;
  min-width: 220px;
}
.toggle{
  display:flex;
  align-items:center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 12px;
  background: rgba(0,0,0,0.18);
  border:1px solid rgba(255,255,255,0.12);
  font-size: 13px;
}
.speed{
  display:flex;
  align-items:center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 12px;
  background: rgba(0,0,0,0.18);
  border:1px solid rgba(255,255,255,0.12);
  font-size: 13px;
}
.speed input[type="range"]{
  width: 120px;
}
.autoStatus{
  display:flex;
  align-items:center;
  gap: 10px;
}
.autoStatus .progress{
  flex: 1;
  height: 8px;
  border-radius: 999px;
  background: rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  overflow:hidden;
}
.autoStatus .bar{
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, rgba(255,176,87,0.9), rgba(255,214,164,0.9));
}
.autoStatus .note{
  min-width: 80px;
  font-size: 12px;
  color: var(--muted2);
  text-align:right;
}

.reply{
  display:flex;
  flex-direction:column;
  gap: 10px;
  padding: 12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.18);
  min-height: 320px;
}
.replyTitle{
  font-weight: 700;
  letter-spacing: 0.3px;
}
.reply textarea{
  width: 100%;
  min-height: 280px;
  resize: vertical;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,0.16);
  background: rgba(255,255,255,0.06);
  color: var(--text);
  padding: 12px 12px;
  font-size: 14px;
  line-height: 1.5;
  outline: none;
}
.reply textarea:focus{
  border-color: rgba(255,176,87,0.45);
  box-shadow: 0 0 0 2px rgba(255,176,87,0.15);
}
.replyHint{
  font-size: 12px;
  color: var(--muted2);
}

.panel{
  background: var(--card);
  border:1px solid var(--line);
  border-radius: 18px;
  padding: 12px;
  box-shadow: var(--shadow);
  display:flex;
  flex-direction:column;
  gap: 10px;
  touch-action: none;
}

.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.seg{ display:flex; gap:8px; padding: 2px; border-radius: 16px; background: rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.12); }
.segBtn{ padding: 10px 10px; }
.segBtn.active{ border-color: rgba(255,176,87,0.42); background: rgba(255,176,87,0.14); }

.grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
}

.ctrl{
  padding: 10px 10px;
  background: rgba(0,0,0,0.18);
  border:1px solid rgba(255,255,255,0.12);
  border-radius: 16px;
}
.ctrl label{
  display:flex; justify-content:space-between;
  color: var(--muted);
  font-weight: 650;
  font-size: 13px;
  margin-bottom: 8px;
}
.ctrl input[type="range"]{ width:100%; touch-action: none; }
.ctrl input[type="color"]{
  width: 100%;
  height: 34px;
  border-radius: 10px;
  border:1px solid rgba(255,255,255,0.16);
  background: rgba(255,255,255,0.06);
  padding: 2px 4px;
}
.ctrl .val{ font-size: 12px; color: var(--muted2); margin-top: 6px; }

.tips{
  padding: 10px 10px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,0.12);
  background: rgba(0,0,0,0.16);
  color: var(--muted);
  display:flex;
  flex-direction:column;
  gap:6px;
}
.tipLine{ font-size: 12px; }
.tipLine.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: rgba(255,255,255,0.76); }

@media (min-width: 900px){
  .stage{ grid-template-columns: minmax(0, 1.05fr) minmax(300px, 0.95fr); }
  .viz{ height: 190px; }
  .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}

@media (orientation: landscape){
  .stage{ grid-template-columns: minmax(0, 1.05fr) minmax(280px, 0.95fr); }
  .reply{ min-height: 100%; }
  .viz{ height: 150px; }
}
